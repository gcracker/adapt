PKG_JSONS := $(shell ls $(addsuffix /package.json,$(PROJ_DIRS_ABS)) 2> /dev/null || true)
NODE_DIRS := $(patsubst %/package.json,%/node_modules,$(PKG_JSONS))

# Don't depend on the timestamp of the actual node_modules directory.
# Depend on the timestamp of a .install_success file that says when
# yarn install actually last successfully completed
NODE_INSTALL_DONE := $(addsuffix /.install_success,$(NODE_DIRS))

$(NODE_INSTALL_DONE): $(REPO_ROOT)/package.json $(REPO_ROOT)/yarn.lock $(PKG_JSONS) $(REPO_ROOT)/node_modules/.install_success
	touch $@

$(REPO_ROOT)/node_modules/.install_success: $(REPO_ROOT)/package.json $(REPO_ROOT)/yarn.lock $(PKG_JSONS)
	cd $(REPO_ROOT) && yarn install
	touch $@
